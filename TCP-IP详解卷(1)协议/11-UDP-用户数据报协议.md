<center style="font-size:24px;font-weight:900;">UDP:用户数据报协议</center>

#### 概述

UDP是一个简单的面向数据报的运输层协议：进程的每个输出操作都正好产生一个UDP数据报，并组装成一份待发送的 IP数据报                        

UDP不提供可靠性：它把应用程序传给 I P层的数据发送出去，但是并不保证它们能到达目的地。

![](F:\studyNote\TCP-IP详解卷(1)协议\img\UDP封装.jpg)

#### UDP首部

UDP首部各字段如图：

![](F:\studyNote\TCP-IP详解卷(1)协议\img\UDP首部.jpg)

端口号表示发送进程和接收进程

UDP长度字段指的是UDP首部和UDP数据的字节长度。该字段的最小值为 8字节（发送一份0字节的UDP数据报是OK）。这个UDP长度是有冗余的。因为IP数据报长度指的是数据报全长，所以UDP数据报长度是全长减去IP首部的长度。

#### UDP检验和

UDP检验和覆盖UDP首部和UDP数据。

UDP和TCP在首部中都有覆盖它们首部和数据的检验和。 UDP的检验和是可选的，而TCP的检验和是必需的。

 UDP数据报和TCP段都包含一个12字节长的伪首部，它是为了计算检验和而设置的。伪首部包含IP首部一些字段。其目的是让UDP两次检查数据是否已经正确到达目的地

UDP数据报中的伪首部格式如图：

![](F:\studyNote\TCP-IP详解卷(1)协议\img\UDP伪首部格式.jpg)

> UDP数据报的长度在检验和计算过程中出现两次。

UDP数据报如果检验和的计算结果为0，则存入的值为全1（65535），这在二进制反码计算中是等效的。如果传送的检验和为0，说明发送端没有计算检验和。

如果发送端没有计算检验和而接收端检测到检验和有差错，那么 UDP数据报就要被悄悄地丢弃。不产生任何差错报文。

UDP检验和是一个端到端的检验和。它由发送端计算，然后由接收端验证。其目的是为了发现UDP首部和数据在发送端到接收端之间发生的任何改动。

#### IP分片

把一份IP数据报分片以后，只有到达目的地才进行重新组装。重新组装由目的端的IP层来完成，其目的是使分片和重新组装过程对运输层（ TCP和UDP）是透明的，除了某些可能的越级操作外。已经分片过的数据报有可能会再次进行分片（可能不止一次）。I P首部中包含的数据为分片和重新组装提供了足够的信息。

当IP数据报被分片后，每一片都成为一个分组，具有自己的IP首部，并在选择路由时与其他分组独立。这样，当数据报的这些片到达目的端时有可能会失序，但是在IP首部中有足够的信息让接收端能正确组装这些数据报片。

#### ICMP不可达差错（需要分片）

发生ICMP不可达差错的另一种情况是，当路由器收到一份需要分片的数据报，而在IP首部又设置了不分片（ DF）的标志比特。

ICMP不可达差错报文格式如图：

![](F:\studyNote\TCP-IP详解卷(1)协议\img\ICMP不可达差错报文格式.jpg)

如果路由器没有提供这种新的ICMP差错报文格式，那么下一站的 MTU就设为0。

#### 用Traceroute确定路径MTU

Traceroute确定MTU要做的是发送分组，并设置“不分片”标志比特。发送的第一个分组的长度正好与出口MTU相等，每次收到ICMP“不能分片”差错时就减小分组的长度。如果路由器发送的ICMP差错报文是新格式，包含出口的MTU，那么就用该MTU值来发送，否则就用下一个最小的MTU值来发送。

#### 最大UDP数据报长度

理论上，IP数据报的最大长度是65535字节，这是由IP首部16比特总长度字段所限制的。去除20字节的 IP首部和8个字节的UDP首部，UDP数据报中用户数据的最长长度为65507字节。但是，大多数实现所提供的长度比这个最大值小。

我们将遇到两个限制因素。第一，应用程序可能会受到其程序接口的限制；第二个限制来自于TCP/IP的内核实现。可能存在一些实现特性（或差错），使I P数据报长度小于65535字节。

#### ICMP源站抑制差错

当一个系统（路由器或主机）接收数据报的速度比其处理速度快时，可能产生ICMP源站抑制差错。注意限定词“可能”。即使一个系统已经没有缓存并丢弃数据报，也不要求它一定要发送源站抑制报文。

下图是ICMP源站抑制差错报文：

![](F:\studyNote\TCP-IP详解卷(1)协议\img\ICMP源站抑制差错报文.jpg)

#### UDP服务器的设计

通常一个客户启动后直接与单个服务器通信，然后就结束了。而对于服务器来说，它启动后处于休眠状态，等待客户请求的到来。对于UDP来说，当客户数据报到达时，服务器苏醒过来，数据报中可能包含来自客户的某种形式的请求消息

影响UDP协议的服务器的设计和实现方面的协议特性:

1. 客户IP地址及端口号
   来自客户的是UDP数据报。IP首部包含源端和目的端IP地址，UDP首部包含了源端和目的端的UDP端口号。当一个应用程序接收到UDP数据报时，操作系统必须告诉它是谁发送了这份消息，即源IP地址和端口号。

2. 目的IP地址
   一些应用程序需要知道数据报是发送给谁的，即目的IP地址。

3. UDP输入队列
   通常程序所使用的每个UDP端口都与一个有限大小的输入队列相联系。这意味着，来自不同客户的差不多同时到达的请求将由UDP自动排队。接收到的UDP数据报以其接收顺序交给应用程序.

4. 限制本地IP地址
   大多数UDP服务器在创建UDP端点时都使其本地IP地址具有通配符 ( wildcard )的特点。这就表明进入的UDP数据报如果其目的地为服务器端口，那么在任何本地接口均可接收到它。

5. 限制远端IP地址
   大多数系统允许UDP端点对远端地址进行限制。这说明端点将只能接收特定IP地址和端口号的UDP数据报。

6. 每个端口有多个接收者
   当UDP数据报到达的目的IP地址为广播地址或多播地址，而且在目的 IP地址和端口号处有多个端点时，就向每个端点传送一份数据报的复制（端点的本地IP地址可以含有星号，它可匹配任何目的IP地址）。

   > 如果UDP数据报到达的是一个单播地址，那么只向其中一个端点传送一份数据报的复制。选择哪个端点传送数据取决于各个不同的系统实现。

