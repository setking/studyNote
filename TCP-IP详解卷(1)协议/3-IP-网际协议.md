<center style="font-size:24px;font-weight:900;">网际协议</center>

#### IP首部

IP数据报的格式如图所示：

![](F:\studyNote\TCP-IP详解卷(1)协议\img\IP首部.jpg)

普通的IP首部长为20个字节

从上图可知4个字节的32 bit值以下面的次序传输：首先是 0～7 bit，其次8～15 bit，然后1 6～23 bit，最后是24~31 bit。这种传输次序称作 big endian字节序。由于TCP/IP首部中所有的二进制整数在网络中传输时都要求以这种次序，因此它又称作网络字节序。

首部长度指的是首部占 32 bit字的数目，包括任何选项。由于它是一个 4比特字段，因此首部最长为6 0个字节

服务类型（TOS）字段包括一个 3 bit的优先权子字段（现在已被忽略），现在大多数的TCP/IP实现都不支持TOS特性

总长度字段是指整个 IP数据报的长度，以字节为单位。利用首部长度字段和总长度字段，就可以知道 IP数据报中数据内容的起始位置和长度。总长度字段是 I P首部中必要的内容，因为一些数据链路（如以太网）需要填充一些数据以达到最小长度。

标识字段唯一地标识主机发送的每一份数据报。通常每发送一份报文它的值就会加 1

TTL（time-to-live）生存时间字段设置了数据报可以经过的最多路由器数。它指定了数据报的生存时间。TTL的初始值由源主机设置（通常为 32或64），一旦经过一个处理它的路由器，它的值就减去 1。当该字段的值为 0时，数据报就被丢弃，并发送 ICMP报文通知源主机。

首部检验和字段是根据IP首部计算的检验和码。它不对首部后面的数据进行计算。 ICMP、IGMP、UDP和TCP在它们各自的首部中均含有同时覆盖首部和数据检验和码。

最后一个字段是任选项，是数据报中的一个可变长的可选信息。目前，这些任选项定义如下：

- 安全和处理限制（用于军事领域）
- 记录路径（让每个路由器都记下它的 I P地址）
- 时间戳（让每个路由器都记下它的 I P地址和时间）
- 宽松的源站选路（为数据报指定一系列必须经过的 I P地址）
- 严格的源站选路（与宽松的源站选路类似，但是要求只能经过指定的这些地址，不能经过其他的地址）。

这些选项很少被使用，并非所有的主机和路由器都支持这些选项

#### IP路由选择

从概念上说， IP路由选择是简单的，特别对于主机来说。如果目的主机与源主机直接相连（如点对点链路）或都在一个共享网络上（以太网或令牌环网），那么IP数据报就直接送到目的主机上。否则，主机把数据报发往一默认的路由器上，由路由器来转发该数据报。大多数的主机都是采用这种简单机制。

IP层在内存中有一个路由表。当收到一份数据报并进行发送时，它都要对该表搜索一次。当数据报来自某个网络接口时， IP首先检查目的IP地址是否为本机的IP地址之一或者IP广播地址。如果确实是这样，数据报就被送到由 IP首部协议字段所指定的协议模块进行处理。如果数据报的目的不是这些地址，那么（ 1）如果IP层被设置为路由器的功能，那么就对数据报进行转发（也就是说，像下面对待发出的数据报一样处理）；否则（ 2）数据报被丢弃。

路由表中的每一项都包含下面这些信息：

- 目的I P地址。它既可以是一个完整的主机地址，也可以是一个网络地址，由该表目中的标志字段来指定。
- 下一站（或下一跳）路由器（ next-hop router）的IP地址，或者有直接连接的网络 IP地址。下一站路由器是指一个在直接相连网络上的路由器，通过它可以转发数据报
- 标志。其中一个标志指明目的 IP地址是网络地址还是主机地址，另一个标志指明下一站路由器是否为真正的下一站路由器，还是一个直接相连的接口
- 为数据报的传输指定一个网络接口

IP路由选择主要完成以下这些功能：

1. 搜索路由表，寻找能与目的 IP地址完全匹配的表目（网络号和主机号都要匹配）。如果找到，则把报文发送给该表目指定的下一站路由器或直接连接的网络接口（取决于标志字段的值）。
2. 搜索路由表，寻找能与目的网络号相匹配的表目。如果找到，则把报文发送给该表目指定的下一站路由器或直接连接的网络接口（取决于标志字段的值）。
3. 搜索路由表，寻找标为“默认（ default）”的表目。如果找到，则把报文发送给该表目指定的下一站路由器。

如果上面这些步骤都没有成功，那么该数据报就不能被传送。如果不能传送的数据报来自本机，那么一般会向生成数据报的应用程序返回一个“主机不可达”或“网络不可达”的错误。

完整主机地址匹配在网络号匹配之前执行。只有当它们都失败后才选择默认路由

为一个网络指定一个路由器，而不必为每个主机指定一个路由器，这是IP路由选择机制的另一个基本特性。这样做可以极大地缩小路由表的规模

#### 子网寻址

现在所有的主机都要求支持子网编址。不是把IP地址看成由单纯的一个网络号和一个主机号组成，而是把主机号再分成一个子网号和一个主机号

大多数的子网例子都是 B类地址。子网对外部路由器来说隐藏了内部网络组织（一个校园或公司内部）的细节。子网对于子网内部的路由器是不透明的。

#### 子网掩码

任何主机在引导时进行的部分配置是指定主机 IP地址。大多数系统把 IP地址存在一个磁盘文件里供引导时读用。

除了IP地址以外，主机还需要知道有多少比特用于子网号及多少比特用于主机号。这是在引导过程中通过子网掩码来确定的。这个掩码是一个 32 bit的值，其中值为 1的比特留给网络号和子网号，为 0的比特留给主机号。

给定I P地址和子网掩码以后，主机就可以确定 I P数据报的目的是：

(1)本子网上的主机；

(2)本网络中其他子网中的主机；

(3)其他网络上的主机。

如果知道本机的 IP地址，那么就知道它是否为A类、B类或C类地址(从IP地址的高位可以得知)，也就知道网络号和子网号之间的分界线。而根据子网掩码就可知道子网号与主机号之间的分界线。

